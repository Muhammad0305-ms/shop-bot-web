<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Чайхана ЕВРОАЗИЯ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    .dish-card { background: white; border-radius: 10px; padding: 10px; margin: 10px 0; display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .dish-card img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; }
    .info { flex: 1; }
    .qty-controls { display: flex; align-items: center; gap: 10px; }
    button { padding: 4px 10px; font-size: 18px; }
    #categories button { margin: 5px; }
    #cart { margin-top: 20px; }
  </style>
</head>
<body>
  <h2>Меню</h2>
  <div id="categories"></div>
  <div id="dishes"></div>
  <div id="cart"></div>
  <input type="text" id="user_name" placeholder="Ваше имя" />
  <input type="text" id="user_phone" placeholder="Телефон" />
  <button id="send">Оформить заказ</button>

  <script>
    let tg = window.Telegram.WebApp;
    tg.expand();

    const menu = {
      "Первые блюда": [
        { name: "Лагман", price: 350, image: "img/lagman.jpg" },
        { name: "Шурпа", price: 300, image: "img/shurpa.jpg" }
      ],
      "Вторые блюда": [
        { name: "Плов", price: 450, image: "img/plov.jpg" }
      ],
      "Десерты": [
        { name: "Чак-чак", price: 150, image: "img/chakchak.jpg" }
      ],
      "Напитки": [
        { name: "Чай", price: 80, image: "img/tea.jpg" },
        { name: "Айран", price: 100, image: "img/ayran.jpg" }
      ]
    };

    const cart = [];

    function renderCategories() {
      const container = document.getElementById('categories');
      container.innerHTML = '';
      for (const category in menu) {
        const btn = document.createElement('button');
        btn.textContent = category;
        btn.onclick = () => renderDishes(category);
        container.appendChild(btn);
      }
    }

    function renderDishes(category) {
      const container = document.getElementById('dishes');
      container.innerHTML = `<h3>${category}</h3>`;
      menu[category].forEach(dish => {
        const div = document.createElement('div');
        div.className = 'dish-card';
        div.innerHTML = `
          <img src="${dish.image}" alt="${dish.name}" />
          <div class="info">
            <h4>${dish.name}</h4>
            <p>${dish.price}₽</p>
            <div class="qty-controls">
              <button onclick="updateQty('${dish.name}', -1)">−</button>
              <span id="qty-${dish.name}">0</span>
              <button onclick="updateQty('${dish.name}', 1)">+</button>
            </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function updateQty(name, delta) {
      const item = cart.find(i => i.name === name);
      if (item) {
        item.qty += delta;
        if (item.qty <= 0) {
          const idx = cart.findIndex(i => i.name === name);
          cart.splice(idx, 1);
        }
      } else if (delta > 0) {
        const { price, image } = findDishByName(name);
        cart.push({ name, qty: 1, price, image });
      }
      renderCart();
      const qtySpan = document.getElementById(`qty-${name}`);
      if (qtySpan) qtySpan.textContent = cart.find(i => i.name === name)?.qty || 0;
    }

    function findDishByName(name) {
      for (const cat in menu) {
        const dish = menu[cat].find(d => d.name === name);
        if (dish) return dish;
      }
    }

    function renderCart() {
      const container = document.getElementById('cart');
      container.innerHTML = `<h3>Корзина</h3>`;
      let total = 0;
      cart.forEach((item, index) => {
        total += item.price * item.qty;
        container.innerHTML += `
          ${item.name} × ${item.qty} — ${item.price * item.qty}₽<br>
        `;
      });
      container.innerHTML += `<p><strong>Итого: ${total}₽</strong></p>`;
    }

    document.getElementById('send').addEventListener('click', () => {
      const name = document.getElementById('user_name').value.trim();
      const phone = document.getElementById('user_phone').value.trim();
      if (name.length < 2 || phone.length < 5) {
        alert('Введите корректные имя и телефон');
        return;
      }
      const total = cart.reduce((sum, item) => sum + item.qty * item.price, 0);
      const order = {
        name,
        phone,
        order: cart,
        total
      };
      tg.sendData(JSON.stringify(order));
      tg.close();
    });

    renderCategories();
  </script>
</body>
</html>
